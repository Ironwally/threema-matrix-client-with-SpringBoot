networks:
  matrix_net:
    name: matrix_net

volumes:
  matrix_db:
    name: matrix_db
  matrix_turn:
    name: matrix_turn

services:
  demo:
    image: demo:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SKIP_TESTS: "false" # change to true to skip tests during image build
    # Uncomment the next line to always disable cache (slower but guarantees rebuild)
    # no_cache: true
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev
      MATRIX_HOST: matrix.local
      MATRIX_USERNAME: admin
      MATRIX_PASSWORD: magentaerenfarve
      MATRIX_ROOM_ID: "!GhYHbLfNOTzPklsVQY:matrix.local"
    depends_on:
      - matrix-server
    networks:
      - matrix_net

  nginx:
    container_name: nginx
    image: nginx:latest
    restart: unless-stopped
    depends_on:
      - matrix-server
    networks:
      - matrix_net
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf

  matrix-server:
    container_name: matrix-server
    image: docker.io/matrixdotorg/synapse:v1.92.2
    restart: unless-stopped
    depends_on:
      - matrix-db
    networks:
      - matrix_net
    ports:
      - 8008:8008/tcp
      - 8448:8448/tcp
    volumes:
      - ./synapse-data:/data
    environment:
      - SYNAPSE_CONFIG_PATH=/data/homeserver.yaml

  matrix-db:
    container_name: matrix-db
    image: docker.io/postgres:12-alpine
    restart: unless-stopped
    networks:
      - matrix_net
    volumes:
      - matrix_db:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=YOUR_POSTGRES_PWD_HERE
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      # ensures the database gets created correctly
      # https://matrix-org.github.io/synapse/latest/postgres.html#set-up-database